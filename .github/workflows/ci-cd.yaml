name: Build & Push Docker (Docker Hub & ECR & ECS)

on:
  push:
    branches: [ master ]

permissions:
  contents: read

jobs:
  docker:
    runs-on: ubuntu-latest
    steps:
      # 1ï¸âƒ£ Checkout Code
      - uses: actions/checkout@v4

      # 2ï¸âƒ£ Java / Maven Setup
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      # 3ï¸âƒ£ Build & Test
      - name: Build & Test
        run: mvn -B -ntp verify

      # 4ï¸âƒ£ Login to Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 5ï¸âƒ£ Configure AWS credentials
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }} # optional, nur nÃ¶tig bei STS
          aws-region: ${{ secrets.AWS_REGION }}

      # 6ï¸âƒ£ Login to AWS ECR
      - name: Login to ECR
        run: |
          aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | docker login --username AWS --password-stdin ${{ secrets.CI_AWS_ECR_REGISTRY }}

      # 7ï¸âƒ£ Extract Docker metadata (tags, labels)
      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ secrets.DOCKERHUB_USERNAME }}/my-app
            ${{ secrets.CI_AWS_ECR_REGISTRY }}/${{ secrets.CI_AWS_ECR_REPOSITORY_NAME }}
          tags: |
            latest
            master

      # 8ï¸âƒ£ Build & Push Docker Image to both registries
      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      # 9ï¸âƒ£ Deploy to ECS
      - name: Deploy to ECS
        run: |
          echo "âž¡ Updating ECS task definition..."
          
          # Neue Task-Definition nur mit gÃ¼ltigen Feldern laden
          aws ecs describe-task-definition \
            --task-definition ${{ secrets.ECS_TASK_FAMILY }} \
            --query "taskDefinition.{family:family, networkMode:networkMode, containerDefinitions:containerDefinitions, requiresCompatibilities:requiresCompatibilities, cpu:cpu, memory:memory, executionRoleArn:executionRoleArn, taskRoleArn:taskRoleArn}" \
            --output json > task-def.json

          # Neues Image einsetzen
          NEW_IMAGE="${{ secrets.CI_AWS_ECR_REGISTRY }}/${{ secrets.CI_AWS_ECR_REPOSITORY_NAME }}:latest"
          echo "Using image: $NEW_IMAGE"
          jq ".containerDefinitions[0].image = \"$NEW_IMAGE\"" task-def.json > new-task-def.json

          # Neue Revision registrieren
          TASK_DEF_ARN=$(aws ecs register-task-definition \
            --cli-input-json file://new-task-def.json \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)
          echo "âž¡ New task definition: $TASK_DEF_ARN"

          # ECS Service aktualisieren
          aws ecs update-service \
            --cluster ${{ secrets.ECS_CLUSTER }} \
            --service ${{ secrets.ECS_SERVICE }} \
            --task-definition "$TASK_DEF_ARN"

          echo "ðŸš€ ECS deployment started successfully."
